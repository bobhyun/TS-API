<!DOCTYPE>
<head>
  <meta charset='utf-8'>
  <title>ex3</title>
  <style>
    body {font-family:Arial, Helvetica, sans-serif}
    div {padding:5px}
    #control {background-color:beige}
    #url, #messages {font-size:0.8em;font-family:'Courier New', Courier, monospace}
    li.open, li.close {color:blue}
    li.error {color:red}
  </style>
</head>
<body>
  <h2>Ex3. Receiving web socket messages</h2>
  <div id='control'>
    <div>
      <input type='text' id='host-name' placeholder='Server IP address:port'>
      <input type='text' id='user-id' placeholder='User ID'> 
      <input type='password' id='password' placeholder='Password'>
    </div>
    <div>
      Topics:
      <input type='checkbox' id="LPR" value="LPR" checked>LPR 
      <input type='checkbox' id="emergencyCall" value="emergencyCall" checked>emergencyCall 
      <button type='button' onClick='onConnect()'>Connect</button>
      <button type='button' onClick='onDisconnect()'>Disconnect</button>
    </div>
    <div id='url'>
    </div>
  </div>

  <div>
    <ul id='messages'></ul>
  </div>
</body>
<script type='text/javascript'>
  (function() {
    window.myApp = { ws: null };
  })();

  function getURL() {
    var url = '';

    if (!('WebSocket' in window)) {
      alert('Your web browser does\'nt support web socket');
      return url;
    }

    var hostName = document.getElementById('host-name').value;
    if(hostName == '') {
      alert('Please enter the host.');
      return url;
    }
    var userId = document.getElementById('user-id').value;
    if(userId == '') {
      alert('Please enter your user ID.');
      return url;
    }
    var password = document.getElementById('password').value;
    if(password == '') {
      alert('Please enter your password.');
      return url;
    }

    var topics = '';
    if(document.getElementById('LPR').checked)
      topics += 'LPR';
    if(document.getElementById('emergencyCall').checked) {
      if(topics.length > 0)
        topics += ',';
      topics += 'emergencyCall';
    }
    if(topics.length == 0) {
      alert('Please select at least one topic.');
      return url;
    }

    var encodedData = window.btoa(userId + ':' + password); // base64 encoding
    url = (hostName.includes('ws://', 0) ? '' : 'ws://') +
      hostName + '/api/subscribeEvents?topics=' + topics + 
      '&auth=' + encodedData;

    return url;
  }

  function addItem(tagClass, msg) {    
    var li = document.createElement('li');
    li.appendChild(document.createTextNode(msg));
    li.classList.add(tagClass); 
    document.getElementById('messages').appendChild(li);
  }

  function onConnect() {
    var url = getURL();
    if(url.length == 0)
      return;

    document.getElementById('url').innerText = url;

    // WebSocket instanecs and it's handlers functions
    var ws = new WebSocket(url);
    ws.onopen = function() {
      addItem('open', 'Connected');
    };
    ws.onclose = function(e) {
      addItem('close', 'Disconnected: ' + e.code);
    };
    ws.onerror = function(e) {
      addItem('error', 'Error: ' + e.code);
    };
    ws.onmessage = function(e) {
      addItem('data', e.data);
    };
    window.myApp.ws = ws;
  }

  function onDisconnect() {
    window.myApp.ws.close();
  }
</script>
